<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<title>contasPeloVencimentoSub</title>

		<style>
			table, td, th {
				
			}

			.col {
				display: none;
			}
			
			.jumbotron {
				text-align: center;
			}
		</style>
		<script src="/html/btp/jquery.js"></script>
	</head>
	<body>
		<div id="listaReceitas"></div>
		
		<script>
		
			function preencheListaReceitas (dtRef){
			
				var lista = [];
				url = "/cgi-bin/financeiro/receitasDoPeriodo.py";
				
				if (dtRef.length > 0) {
					url += "?dtRef=" + dtRef;
				}

				$.getJSON(url, function(data) {

					console.log(data);
					lista = data.receitasDoPeriodo;
					var saida = "";

					for (i = 0; i < lista.length; i++) {

						var codReceita = lista[i].codReceita;

						var referencia = 
							lista[i].pagador + " - Ref: " +
							lista[i].mesRef + " em: " +
							lista[i].dtCreditoMin
						;

						var ttlContas = lista[i].valorTtlContas.toFixed(2);
						var ttlPagas = lista[i].valorTtlContasPagas;
						var valorReceita = 0.0;

						if (lista[i].valorReceita > 0){
							valorReceita = lista[i].valorReceita;
						} else {
							valorReceita = lista[i].mediaReceita;
						}

						var sldGeral = (valorReceita - ttlContas).toFixed(2);
						var sldBanco = (lista[i].valorReceita - ttlPagas).toFixed(2);


						saida =
							"<div class='panel panel-default'>" +
								"<div class='panel-heading'>" +
									"<h4>Receita</h4>" +
									"<a class='receita' target='_blanc' " +
										"href='/html/modelos/financeiro/receita.html?cod=" +
											lista[i].codReceita + "'>" +
										referencia +
									"</a>" +
									"<br>" +
									"total receita: " + valorReceita + "";

						if (lista[i].valorReceita == 0) {
							saida += " (previs√£o)";
						}

						saida += "<br>";

						saida +=
									"<div class='btn-group' id='btnReceita'>" +
										"<a " +
											"class='mais btn btn-success btn-sm' " +
											"href='#' " +
											"id='detalhes?" + codReceita + "' " +
											">detalhes</a>" +
										"<a " + 
											"class='mais btn btn-success btn-sm' " +
											"target='_blank' " +
											"href='/html/financeiro/contasPelaReceita.html?cod=" + codReceita + "' " +
											"id='contas?" + codReceita + "'>contas</a>" +
									"</div>" +
									"<div class='dtlReceita' id='detalhesReceita" + codReceita + "'>" +
										"total debitos: " + ttlContas + "<br>" +
										"total Saldo geral: " + sldGeral + "<br>" +
										"total Saldo no banco: " + sldBanco + "<br>" +
									"</div>" +
								"</div>" +
								"<div class='panel-body' id='panelReceita" + codReceita + "'></div>" +
							"</div>" 

						saida = saida.replace("%r", "<br>");
						saida = saida.replace("%n", "<br>");

						$("#listaReceitas").append(saida);

						$("#panelReceita" + codReceita).load(
							"/html/financeiro/contasPelaReceita.html?cod=" + codReceita
						);
						
						$("#panelReceita" + codReceita).css("display", "none");
						$(".dtlReceita").css("display", "none");

					}

				}).fail(function(jqxhr, textStatus, error){
					var err = textStatus + ", " + error;
					console.log("ERRO!!! " + err)
				}).success(function(){
					$(".mais").on("click", function(){
						event.preventDefault();

						var cod = $(this).attr("id").split("?")[1];
						var id = $(this).attr("id").split("?")[0];

						if (id == "detalhes") {
							if ($("#detalhesReceita" + cod).css("display") == 'none'){
								$("#detalhesReceita" + cod).css("display", 'block')
							} else {
								$("#detalhesReceita" + cod).css("display", 'none')
							}
						}

						if (id == "contas") {
							if ($("#panelReceita" + cod).css("display") == 'none'){
								$("#panelReceita" + cod).css("display", 'block')
							} else {
								$("#panelReceita" + cod).css("display", 'none')
							}
						}
					});
				});




			}
		
		
			$(document).ready(function() {
			
				var searchParams = "";
				var dtRef = "";
				
				if ($("#principal").length > 0) {
					//url = new URL($("#principal").attr("url"));
					searchParams = $("#principal").attr("url").split("?")[1];
				} else {
					searchParams = window.location.search;
				}
				
				searchParams = new URLSearchParams(searchParams);
				
				if (searchParams.has('dtRef')) {
					dtRef = searchParams.get("dtRef");
				} else {
					dtRef = 
						d.getFullYear() + "-" + 
						("00" + (d.getMonth() + 1)).substr(-2)
				}
			
				preencheListaReceitas(dtRef);
			});
		</script>
	</body>
</html>
