<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<title>contasPeloVencimentoSub</title>

		<style>
			table, td, th {
				
			}

			.col {
				display: none;
			}
			
			.jumbotron {
				text-align: center;
			}
		</style>
		<script src="/html/btp/jquery.js"></script>
	</head>
	<body>
		<div id="listaReceitas"></div>
		
		<script>
		
			function preencheListaReceitas (dtRef){
			
				var lista = [];
				url = "/cgi-bin/financeiro/receitasDoPeriodo.py";
				
				if (dtRef.length > 0) {
					url += "?dtRef=" + dtRef;
				}

				$.getJSON(url, function(data) {

					console.log(data);
					lista = data.receitasDoPeriodo;
					var saida = "";

					for (i = 0; i < lista.length; i++) {

						var codReceita = lista[i].codReceita;
						var ttlContas = lista[i].valorTtlContas;
						var ttlPagas = lista[i].valorTtlContasPagas;
						var valorReceita = 0.0;

						if (lista[i].valorReceita > 0){
							valorReceita = lista[i].valorReceita;
						} else {
							valorReceita = lista[i].mediaReceita;
						}


						saida =
							"<div class='panel panel-default'>" +
								"<div class='panel-heading'>" +
									"<h2>Receita</h2>" +
									"ref: " + lista[i].referencia + "<br>" +
									"total receita: " + valorReceita + "";

						if (lista[i].valorReceita == 0) {
							saida += " (previs√£o)";
						}

						saida += "<br>";

						saida +=
									"total debitos: " + ttlContas + "<br>" +
									"total Saldo geral: " + (valorReceita - ttlContas) + "<br>" +
									"total Saldo no banco: " + (lista[i].valorReceita - ttlPagas ) + "<br>" +
									"<a " + 
										"class='mais btn btn-success' " +
										"target='_blank' " +
										"onClick='mais(" + codReceita + ");' " + 
										"href='/html/financeiro/contasPelaReceita.html?cod=" + codReceita + "' " +
										"id='mais" + codReceita + "'>+</a>" +
								"</div>" +
								"<div class='panel-body' id='panelReceita" + codReceita + "'></div>" +
							"</div>" 

						saida = saida.replace("%r", "<br>");
						saida = saida.replace("%n", "<br>");

						$("#listaReceitas").append(saida);

						$("#panelReceita" + codReceita).load(
							"/html/financeiro/contasPelaReceita.html?cod=" + codReceita
						);
						
						$("#panelReceita" + codReceita).css("display", "none");

					}

				}).fail(function(jqxhr, textStatus, error){
					var err = textStatus + ", " + error;
					console.log("ERRO!!! " + err)
				});

				$(".mais").on("click", function(event){
				});

			}
		
			function mais(cod){
				event.preventDefault();

				if ($("#panelReceita" + cod).css("display") == 'none'){
					$("#panelReceita" + cod).css("display", 'block')
				} else {
					$("#panelReceita" + cod).css("display", 'none')
				}

			}
		
		
			$(document).ready(function() {
			
				var searchParams = "";
				var dtRef = "";
				
				if ($("#principal").length > 0) {
					//url = new URL($("#principal").attr("url"));
					searchParams = $("#principal").attr("url").split("?")[1];
				} else {
					searchParams = window.location.search;
				}
				
				searchParams = new URLSearchParams(searchParams);
				
				if (searchParams.has('dtRef')) {
					dtRef = searchParams.get("dtRef");
				} else {
					dtRef = 
						d.getFullYear() + "-" + 
						("00" + (d.getMonth() + 1)).substr(-2)
				}
			
				preencheListaReceitas(dtRef);
			});
		</script>
	</body>
</html>
