<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta content="text/html; charset=UTF-8" http-equiv="content-type">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>registro</title>
		<style>
			table, td, th {
				border:solid;
			}

			.colx {
				display: none;
			}
		</style>
		<script src="/html/btp/jquery.js"></script>
	</head>
	<body>
		<div class="container">
			<div class="row-fluid"> 
				<a href="/html/modelos/passmots/registro.html" target="_blank">
					<h1>Registro</h1>
				</a>
				<h2>Vertical (basic) form</h2>
				<form id="registroFrm">
					<div class="form-group" id="codRegistroDiv"> 
						<label for="codRegistro">codRegistro</label>
						<input 
							class="form-control" id="codRegistro" name="codRegistro" 
							aria-describedby="codRegistroHelp"
							placeholder="codRegistro" type="number"> 
						<br>
						<small id="codRegistroHelp"
							   class="form-text text-muted">codRegistro</small>
					</div>
					<div class="form-group" id="codOrigemRegistroDiv"> 
						<label for="codOrigemRegistro">codOrigemRegistro</label>
						<input class="form-control" id="codOrigemRegistro" name="codOrigemRegistro" 
							   placeholder="codOrigemRegistro" type="number">
					</div>
					<div class="form-group" id="codTipoCampoDiv"> 
						<label for="codTipoCampo">codTipoCampo</label>
						<input class="form-control" id="codTipoCampo" name="codTipoCampo" 
							   placeholder="codTipoCampo" type="number">
					</div>
					<div class="form-group" id="ordemDiv"> 
						<label for="ordem">ordem</label>
						<input class="form-control" id="ordem" name="ordem" 
							   placeholder="ordem" type="number">
					</div>
					<div class="form-group" id="registroDiv"> 
						<label for="registro">registro</label>
						<input class="form-control" id="registro" name="registro" 
							   placeholder="registro" type="text">
						<button id="newPass">Gerar Nova Senha</button>
					</div>
					<div class="form-group" id="dtAtualizacaoDiv"> 
						<label for="dtAtualizacao">dtAtualizacao</label>
						<input class="form-control" id="dtAtualizacao" name="dtAtualizacao" 
							   placeholder="dtAtualizacao" type="datetime-local">
					</div>
				</form>
			</div>
			<div class="row-fluid btn-group">
				<button class="salvar btn btn-primary">Salvar</button> 
				<button class="copiar btn btn-success">Copiar</button> 
				<button class="salvar btn btn-danger">Excluir</button> 
			</div>
		</div>
		
		
		<script>

			var variavel = 0;

			function gerarSenha(){
				var ascII = [
					64, 35, 36, 37, 33, 42, 43, 45, 46, 95, 
					48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 
					65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 
					75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 
					85, 86, 87, 88, 89, 90, 97, 98, 99, 100, 
					101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 
					111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 
					121, 122
				]

				str = "";
				i = 0;

				while (i < 15) {
					x = Math.floor((Math.random() * 71) + 1);
					str += String.fromCharCode(ascII[x]);
					i++;
				}

				$("#registro").val(str);
			};

			function preencheForm() {

				var url = "/cgi-bin/passmots/registro.py";

				if (variavel > 0) {
					url += "?cod=" + variavel;
				}

				$.getJSON(url, function (data) {
					//console.log(data);
					var obj = data.registro;

					$("#codRegistro").val(obj[0].codRegistro);
					$("#codOrigemRegistro").val(obj[0].codOrigemRegistro);
					$("#codTipoCampo").val(obj[0].codTipoCampo);
					$("#ordem").val(obj[0].ordem);
			
					$("#registro").val(obj[0].registro.replace("/%r%n/g", "\n", -1));
					$("#dtAtualizacao").val(obj[0].dtAtualizacao);
				})
				.done(function( json ) {
					carregaCombos();
				});
			}

			function formNull() {
				$("#codRegistro").val(0);
				$("#codOrigemRegistro").val(0);
				$("#codTipoCampo").val(0);
				$("#ordem").val(0);
				$("#registro").val("");
				$("#dtAtualizacao").val("0001-01-01T00:00");
		
				carregaCombos();
			}

			$("form").submit(function (event) {
				event.preventDefault();
			});

			function carregaCombos() {
				var param = "";

				param = encodeURI("cod=" + $("#codOrigemRegistro").val());
				$("#codOrigemRegistroDiv").attr('param', param);
				$("#codOrigemRegistroDiv").load("/html/modelos/passmots/origemRegistroCmb.html");

				param = encodeURI("cod=" + $("#codTipoCampo").val());
				$("#codTipoCampoDiv").attr('param', param);
				$("#codTipoCampoDiv").load("/html/modelos/passmots/tipoCampoCmb.html");
			}

			$("#newPass").on("click", function () {
				//event.preventDefault();
				var conf = confirm("Deseja realmente gerar\numa nova senha?");
				
				if (conf){
					gerarSenha();
				}
			});


			$(document).ready(function () {
				$("#codRegistroDiv").css("display", "none");

				$(".copiar").on("click", function(){
					$("#codContaDiv").css("display", "block");
					$("#codConta").val(0);
				});
				
				$(".salvar").on("click", function(){
					var txt = $(this).html();
					var frm = $("#registroFrm");
					var action = "/cgi-bin/passmots/salvaRegistro.py";
					var dados = "";
					
					if (txt === "Salvar") {
						dados = frm.serialize();
					} else if (txt === "Excluir") {
						dados = frm.serialize() + "&delete=True";
					}
					
					$.post(
						action, 
						dados, 
						function(data) {
							alert("Dados salvos!");
							//console.log(data);
						}
					)
				});
				
				var searchParams = "";
				
				if ($("#principal").length > 0) {
					//url = new URL($("#principal").attr("url"));
					searchParams = $("#principal").attr("url").split("?")[1];
				} else {
					searchParams = window.location.search;
				}
				
				searchParams = new URLSearchParams(searchParams);
				
				if (searchParams.has('cod')) {
					variavel = searchParams.get("cod");
					preencheForm();
				} else {
					formNull();
				}

				if (searchParams.has('cod2')) {
					$("#codOrigemRegistro").val(searchParams.get("cod2"));
				}

			});

		</script>
	</body>
</html>
