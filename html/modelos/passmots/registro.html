<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta content="text/html; charset=UTF-8" http-equiv="content-type">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>registro</title>
		<style>
			table, td, th {
				border:solid;
			}

			.colx {
				display: none;
			}
		</style>
		<script src="/html/btp/jquery.js"></script>
	</head>
	<body>
		<div class="container">
			<div class="row-fluid"> 
				<a href="/html/modelos/passmots/registro.html" target="_blank">
					<h1>Registro</h1>
				</a>
				<h2>Vertical (basic) form</h2>
				<form>
					<div class="form-group" id="codRegistroDiv"> 
						<label for="codRegistro">codRegistro</label>
						<input 
							class="form-control" id="codRegistro" name="codRegistro" 
							aria-describedby="codRegistroHelp"
							placeholder="codRegistro" type="number"> 
						<br>
						<small id="codRegistroHelp"
							   class="form-text text-muted">codRegistro</small>
					</div>
					<div class="form-group" id="codOrigemRegistroDiv"> 
						<label for="codOrigemRegistro">codOrigemRegistro</label>
						<input class="form-control" id="codOrigemRegistro" name="codOrigemRegistro" 
							   placeholder="codOrigemRegistro" type="number">
					</div>
					<div class="form-group" id="codTipoCampoDiv"> 
						<label for="codTipoCampo">codTipoCampo</label>
						<input class="form-control" id="codTipoCampo" name="codTipoCampo" 
							   placeholder="codTipoCampo" type="number">
					</div>
					<div class="form-group" id="ordemDiv"> 
						<label for="ordem">ordem</label>
						<input class="form-control" id="ordem" name="ordem" 
							   placeholder="ordem" type="number">
					</div>
					<div class="form-group" id="registroDiv"> 
						<label for="registro">registro</label>
						<input class="form-control" id="registro" name="registro" 
							   placeholder="registro" type="text">
						<button id="newPass">Gerar Nova Senha</button>
					</div>
					<div class="form-group" id="dtAtualizacaoDiv"> 
						<label for="dtAtualizacao">dtAtualizacao</label>
						<input class="form-control" id="dtAtualizacao" name="dtAtualizacao" 
							   placeholder="dtAtualizacao" type="datetime-local">
					</div>
				</form>
			</div>
			<div class="row-fluid">
				<button class="btn btn-primary">Salvar</button> 
				<button class="btn btn-danger">Excuir</button> 
			</div>
		</div>
	</body>
</html>


<script>

	var variavel = 0;

	function gerarSenha(){
		var ascII = [
			64, 35, 36, 37, 33, 42, 43, 45, 46, 95, 
			48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 
			65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 
			75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 
			85, 86, 87, 88, 89, 90, 97, 98, 99, 100, 
			101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 
			111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 
			121, 122
		]

		str = "";
		i = 0;

		while (i < 15) {
			x = Math.floor((Math.random() * 71) + 1);
			str += String.fromCharCode(ascII[x]);
			i++;
		}

		$("#registro").val(str);
	};

	function formatDate(date) {

		var date = new Date(date);

		var year = date.getFullYear();
		var month = ("00" + (date.getMonth() + 1)).slice(-2); // months are zero indexed
		var day = ("00" + (date.getDate())).slice(-2);
		var hour = ("00" + (date.getHours())).slice(-2);
		var minute = ("00" + (date.getMinutes())).slice(-2);
		var second = date.getSeconds();
		var hourFormatted = hour % 12 || 12; // hour returned in 24 hour format
		var minuteFormatted = minute < 10 ? "0" + minute : minute;
		var morning = hour < 12 ? "am" : "pm";

		var formated = year + "-" + month + "-" + day + "T" + hour + ":" +
		minute;

		return formated;

		/*
		return month + "/" + day + "/" + year + " " + hourFormatted + ":" +
		minuteFormatted + morning;
		*/
	}

	function preencheForm() {

		var url = "/cgi-bin/passmots/registro.py";

		if (variavel > 0) {
			url += "?cod=" + variavel;
		}

		$.getJSON(url, function (data) {

			//console.log(data);
			var registro = data.registro;

			$("#codRegistro").val(registro[0].codRegistro);
			$("#codOrigemRegistro").val(registro[0].codOrigemRegistro);
			$("#codTipoCampo").val(registro[0].codTipoCampo);
			$("#ordem").val(registro[0].ordem);
			
			$("#registro").val(registro[0].registro.replace("/%r%n/g", "\n", -1));
			$("#dtAtualizacao").val(formatDate(registro[0].dtAtualizacao));
			
			carregaCombos(registro[0].codOrigemRegistro, registro[0].codTipoCampo);
		});
	}

	function formNull() {
		$("#codRegistro").val(0);
		$("#codOrigemRegistro").val(0);
		$("#codTipoCampo").val(0);
		$("#ordem").val(0);
		$("#registro").val("");
		$("#dtAtualizacao").val("0001-01-01T00:00");
		
		carregaCombos(0, 0);
	}

	function carregaCombos(codOrigemRegistro, codTipoCampo) {

		param = encodeURI("cod=" + codOrigemRegistro);

		$("#codOrigemRegistroDiv").attr('param', param);
		$("#codOrigemRegistroDiv").load("/html/modelos/passmots/origemRegistroCmb.html");

		param = encodeURI("cod=" + codTipoCampo);

		$("#codTipoCampoDiv").attr('param', param);
		$("#codTipoCampoDiv").load("/html/modelos/passmots/tipoCampoCmb.html");
	}

	$("form").submit(function (event) {
		event.preventDefault();
	});
	
	
	$("#newPass").on("click", function () {
		//event.preventDefault();
		var conf = confirm("Deseja realmente gerar\numa nova senha?");
		
		if (conf){
			gerarSenha();
		}
	});
	

	$(document).ready(function () {
		formNull();
		//$("#codRegistroDiv").css("display", "none");

		$("button").on("click", function(){
			var txt = $(this).html();
			var action = "/cgi-bin/passmots/salvaRegistro.py";

			if (txt === "Salvar") {
				alert(1);

				$.post(
					action, 
					$(this).serialize(), 
					function(data) {
						alert("Dados salvos!");
						console.log(data);
					}
				);

			} else if (txt === "Excuir") {
				alert(2);
			}
		});

		//procura na url da pagina
		var urlParams = new URLSearchParams(window.location.search);

		if ((urlParams.has('cod'))){
			variavel = urlParams.get("cod");
			preencheForm();
		}

		//procura na div container
		let params = decodeURI(
			$("#codRegistroDiv")
				.parent()
				.parent()
				.parent()
				.parent()
				.attr('param')
		);

		let searchParams = new URLSearchParams(params);

		if (searchParams.has("cod")){
			variavel = searchParams.get("cod");
			preencheForm();
		}

	});

</script>

